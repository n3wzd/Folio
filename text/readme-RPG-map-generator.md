# RPG Map Generator

---

2024-05 ~ 2024-08 (1인)

## 배경
RPG Map Generator는 무작위 RPG 세계를 생성하는 도구입니다. 던전, 동굴, 경로, 자연 등의 맵 생성 방식을 제공합니다. 선택한 타일 테마에 따라 구역 타일과 장식 타일을 랜덤하게 배치하여 매번 새롭고 독특한 맵을 제공합니다. 생성된 맵은 이미지나 json 파일로 추출하여 자신만의 맵으로 활용할 수 있습니다.

## 기능
- 4가지 맵 생성 (던전, 동굴, 평지, 자연)
- 그래프 경로 생성
- 타일 테마 선택
- 무작위 영역 타일 배치
- 무작위 장식 타일 배치
- json, png 파일 다운로드
	- `RPG Maker MV`와 호환됩니다.
- 파라미터 세팅 저장 & 불러오기

## 스택
- Python: 개발 언어

### 패키지
- Tkinter: GUI 프레임워크

## 문제 및 해결
무작위로 던전을 생성하는 방법은 무엇일까요? 무작위로 단순히 타일들을 배치하는 방법도 있지만, 일관성과 논리적인 구조를 유지하기 어렵습니다. 미리 정의된 맵들을 무작위로 불러오는 방법도 좋지만, 호출 횟수가 반복되면 사용자가 맵에 익숙하여 중복된다는 느낌을 받을 수 있습니다. 따라서 일관성 있고 논리적인 구조를 유지하되, 항상 새로운 맵을 생성할 필요가 있습니다. 이 문제를 해결하기 위해 `PCG` 기법을 사용하려고 합니다.

`PCG`(Procedural Content Generation)은 컴퓨터 알고리즘을 사용하여 콘텐츠를 자동으로 생성하는 기법입니다. PCG는 무작위성을 도입하면서 특정 규칙과 제약을 적용하여 논리적이고 일관성 있는 컨텐츠를 생성합니다. 이 방법은 게임, 영화, 음악, 그래픽 디자인 등 다양한 분야에서 사용될 수 있습니다.

### 던전 생성: BSP
사각형 구조의 던전을 무작위로 생성해야 합니다. 무작위로 사각형을 배치하는 방법은 방들이 겹치는 문제가 발생할 수 있습니다. 일관성 있고 논리적인 알고리즘을 통해 공간을 생성할 필요가 있습니다.

`BSP`(Binary Space Partitioning, 이진 공간 분할) 알고리즘은 공간을 두 개의 하위 공간으로 재귀적으로 분할하는 방법입니다. 분할이 완료된 각 하위 공간은 방이나 구역으로 사용할 수 있습니다. BSP 알고리즘으로 생성된 던전의 구조가 무작위이지만, 방들이 논리적으로 배치되고 길을 쉽게 연결할 수 있어 사용자가 원하는 던전을 생성할 수 있습니다.

먼저 빈 직사각형 공간을 생성합니다. 그리고 공간을 무작위로 두 개의 하위 공간으로 수직 또는 수평으로 분할합니다. 이 과정을 더 이상 나눌 수 없을 때까지 재귀적으로 반복하며, 최종적으로 분할이 완료된 각 하위 공간은 방이나 구역으로 변환됩니다.

다음으로 생성된 방을 길로 연결합니다. 길이 되도록 방을 관통하지 않도록 최단 거리를 기반으로 길을 생성할 필요가 있습니다. 맵을 `그래프`로 간주하고 방을 정점, 길을 간선으로 정의한 다음, 방 사이의 최단 경로를 찾아 길를 연결하고자 합니다. 모든 정점에서 최단 거리를 찾아야 하므로`Floyd-Warshall` 알고리즘을 사용하기로 했습니다. 이 알고리즘을 사용하여 모든 방과 방 사이의 최단 거리를 계산한 후, 인접한 최단 거리를 따라 연결할 방과 방의 쌍을 매칭합니다. 마지막으로 모든 매칭된 쌍에 대해 직각 모양으로 길을 구현합니다.

최종적으로 각기 다른 크기와 모양의 방들이 연결된 사각형 구조의 던전이 생성됩니다. 생성된 던전은 각기 다른 크기와 모양의 방들이 복도와 균형 있게 연결되어 있으며, 사용자에게 새로운 레이아웃을 제공합니다.

### 동굴 생성: 셀룰러 오토마타
동굴 내부는 일반적으로 좁고, 벽 타일이 울퉁불퉁하게 배치되어 있습니다. 이러한 지형을 생성하는 기법은 `셀룰러 오토마타`가 적합하다고 판단했습니다.

`셀룰러 오토마타`는 격자 맵에서 상태를 가진 각 타일들이 이웃한 셀들과의 상호작용을 통해 상태를 변화시키는 계산 모델입니다. 이 모델은 간단한 규칙에 따라 복잡한 패턴을 생성할 수 있습니다. 일반적인 이웃 형태는 무어 이웃(8개의 인접한 셀)과 폰 노이만 이웃(4개의 인접한 셀)이 있으며, 지금은 무어 이웃을 적용하고자 합니다. 셀룰러 오토마타에서는 아래와 같은 파라미터를 사용합니다.

`wall_probability`: 초기에 벽을 생성할 확률입니다. 0에서 1까지 값을 가지며, 1에 가까울수록 맵에 벽이 많아지며, 동굴이 좁거나 막힌 구조가 될 가능성이 커집니다. 적정 값 범위는 0.4 ~ 0.6입니다.
`cellular_iterations`: 시뮬레이션 반복 횟수입니다. 반복 횟수가 많을수록 동굴이 더 정제되고 매끄러운 패턴을 형성합니다. 적정 값 범위는 3 ~ 10입니다.
`birth_limit` = 현재 칸이 빈 공간일 때, 주변에 이 값 이상으로 벽이 있으면 해당 셀을 벽으로 변경합니다. 적정 값은 4입니다.
`death_limit` = 현재 셀이 벽일 때, 주변에 이 값 이하로 벽이 있으면 해당 셀을 빈 공간으로 변경합니다. 적정 값은 4입니다.

1. 각 타일을 `wall_probability`에 따라 벽 또는 빈 공간으로 설정됩니다.
2. 각 타일에의 인접한 벽 타일의 개수에 따라 현재 타일을 벽으로 만들지 빈 공간으로 만들지를 결정합니다.
  - 만약 현재 타일이 벽이라면, 주변 벽이 `birth_limit` 이상이면 벽을 유지하고, 그렇지 않으면 빈 공간으로 변경합니다.
  - 만약 현재 타일이 빈 공간이라면, 주변 벽이 `death_limit`보다 많으면 벽으로 바뀌고, 그렇지 않으면 빈 공간으로 유지됩니다.
3. 2번 과정을 `cellular_iterations`에 설정된 횟수만큼 반복합니다.

최종적으로 동굴의 자연스러운 경계와 구불구불한 길이 생성되어 사용자에게 색다른 경험을 제공합니다.

### 지형 생성: 심플렉스 노이즈
높낮이가 있는 자연스러운 지형을 생성해야 합니다. 각 칸에 무작위 높이를 정하는 방법도 있지만, 이는 인접한 칸을 고려하지 않으므로 주변 타일 간 높낮이 차가 연속적이지 않아 전체적으로 부자연스럽다는 문제가 있습니다. 이를 해결하기 위해 `퍼린 노이즈` 알고리즘을 사용하고자 합니다.

`퍼린 노이즈`(Perlin Noise)는 주로 자연적인 지형을 시뮬레이션하는 데 사용됩니다. 이 알고리즘은 부드럽고 유기적인 패턴을 생성하여 게임이나 그래픽 디자인에서 활용됩니다. 격자 맵에서 퍼린 노이즈 알고리즘을 적용하면 각 칸들이 연속적인 높낮이 값을 가진 노이즈가 생성되며, 이 높낮이를 기반으로 타일을 배치하면 자연스러운 지형이 생성됩니다. 하지만 퍼린 노이즈는 생성되는 지형에 전형적인 패턴이 생기는 단점이 있습니다. 이러한 패턴은 무작위성을 저해하며 생성되는 맵이 인위적으로 느껴질 수 있습니다.

이를 보완하기 위해 `심플렉스 노이즈`를 사용하고자 합니다. `심플렉스 노이즈`는 퍼린 노이즈의 단점을 개선하기 위해 개발된 노이즈 함수로, 더 효율적으로 고차원 노이즈를 생성하고, 더 자연스러운 패턴을 제공합니다. 이 노이즈는 임의의 시드를 생성하고 벡터 연산을 통해 생성되며, 이를 기반으로 타일을 배치하면 퍼린 노이즈를 사용한 지형보다 더욱 자연스러운 맵이 만들어집니다.

최종적으로 높낮이가 있으며 주변 높낮이가 부드럽게 변하는 자연스러운 지형이 만들어져, 부드러운 언덕과 깊은 골짜기 같은 다양한 지형을 경험할 수 있습니다.

### 경로 생성: 그래프 최단거리 A*
일반적으로 마을 맵은 건물이 있으며, 각 건물은 자연스러운 길로 연결되어 있습니다. 맵을 `그래프`로 정의했을 때, 마을은 정점이고 길은 간선으로 볼 수 있습니다. 마을을 무작위로 생성한다면 모든 건물들은 연결되어 있다는 규칙을 유지해야 합니다. 그래프 알고리즘을 사용한다면 이러한 규칙이 지켜지면서 무작위 마을 구조를 만들 수 있습니다.

먼저 맵에 무작위 위치에 건물이 있다고 합시다. 이 건물들이 모두 연결된 그래프를 생성해야 합니다. 이 그래프는 사이클이 없고 최단 거리로 정점이 연결되어야 합니다. 이 그래프는 `MST`(Minimum Spanning Tree, 최소 신장 트리)로 볼 수 있으며, MST 생성 알고리즘을 사용하면 문제를 해결할 수 있을 것입니다. `Prim` 알고리즘을 사용하여 건물을 모두 연결한 그래프를 생성합니다.

다음으로 건물들을 연결하는 길을 배치해야 합니다. 던전과 달리 일반적인 마을의 길 모양은 직선이 아닐 수 있습니다. 따라서 길에 포함된 모든 칸을 찾을 필요가 있으며, 건물 간 최단 경로를 찾아야 합니다.

그래프 최단거리는 `다익스트라` 알고리즘으로 구할 수 있습니다. 다익스트라 알고리즘을 사용해서 정점 간 최단 경로를 찾은 다음, 최단 경로를 기준으로 가까운 마을을 서로 매칭하여 경로를 따라 길을 연결합니다. 하지만 항상 최단 경로로 길이 연결된다면, 사용자 입장에선 마을이 인위적으로 생성된 것 같다는 느낌을 받을 수 있습니다. 따라서 길은 최단 경로를 기반으로 하되, 약간의 무작위성이 필요합니다.

이 문제를 해결하기 위해 `A*` 알고리즘을 활용하고자 합니다. A* 알고리즘은 다익스트라 알고리즘에서 휴리스틱 함수가 추가된 것으로, 휴리스틱 함수는 정점 탐색 순서에 영향을 줍니다. 휴리스틱 함수가 최단 거리에서 임의의 값을 더하여 반환함으로써, 최단 경로와 가까우면서 방향이 무작위로 바뀌는 경로가 생성됩니다. (휴리스틱 함수에 있는 임의의 값의 크기가 커질수록 무작위성이 강화됩니다.) 이 경로를 따라 길 타일을 배치하여 길을 생성할 수 있습니다.

최종적으로 모든 건물이 자연스럽게 연결된 마을이 생성됩니다. 사용자는 매번 다른 구조의 마을을 탐험하게 되어 새로운 경험을 제공합니다.
