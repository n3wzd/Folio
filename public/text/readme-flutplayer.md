# FlutPlayer

---

2023-09 ~ 2024-01 (1인)

## 기능
- 오디오
    - 재생 슬라이더
    - 재생 / 일시정지
    - 다음 트랙 이동, 이전 트랙 이동
    - 셔플, 반복 재생 모드
    - mashup 모드
    - 볼륨 조절
- 재생 목록
    - 목록 정렬, 목록 초기화
    - 음원 이동 (드래그 앤 드랍)
    - 음원 제거 (스와이프)
- 태그
    - 선택한 태그를 재생 목록으로 불러오기
    - 태그 추가, 업데이트, 삭제
    - 태그 즐겨찾기 기능
    - 데이터베이스 저장
- 이퀄라이저
    - 밴드의 게인 값 조절
    - 스무스 슬라이더 이동
- 배경
    - 로컬 파일 내 배경 파일 선택 가능
    - 이미지 배경 회전, 확대/축소, 색상 필터링 여부 설정
    - 배경 밝기 조절
    - 기본 애니메이션 백그라운드
- NCS(NoCopyrightSounds) 비주얼라이저
    - 15가지 색상 설정
- 설정
    - 태그, 정렬, mashup, 이퀄라이저, 배경, 비주얼라이저
    - 데이터베이스, CSV 파일 내보내기 / 불러오기
- 기타
    - 백그라운드 프로세스 지원
    - 알림바 UI 제공

## Stack
- Flutter

### Dependency
- just_audio: ^0.9.35
- audioplayers: ^5.2.0
- file_picker: ^6.0.0
- permission_handler: ^11.0.1
- audio_service: ^0.18.12
- sqflite: ^2.3.0
- sqflite_common_ffi: ^2.3.0
- shared_preferences: ^2.2.2
- video_player: ^2.8.2

## 문제 및 해결
### 1. 셔플 기능 구현
- **문제**: 음악 재생 리스트에서 셔플 기능을 구현하고, 셔플을 해제했을 때 원래 리스트 상태로 복원해야 합니다.
- **해결**:
	1. **셔플 사용**: 현재 재생 리스트의 상태를 백업하고 `shuffle()` 메서드를 사용해 리스트를 섞습니다. 현재 트랙을 첫 번째 위치로 이동시킵니다.
	2. **셔플 해제**: 백업해둔 원래 리스트를 복원하여 셔플 이전 상태로 되돌립니다.

### 2. 프로퍼티 변경 시 위젯 업데이트
- **문제**: 특정 프로퍼티(A)가 변경되었을 때 관련된 위젯(B)이 자동으로 업데이트해야 합니다.
- **해결**:
  1. 프로퍼티가 변경되면 A와 연관된 `StreamController`를 통해 신호를 보냅니다.
  2. 해당 신호를 받은 B를 포함한 `StreamBuilder`가 자동으로 재로딩됩니다.
  3. `StreamBuilder`가 다시 렌더링되면서 변경된 프로퍼티 값을 반영합니다.

### 3. 매시업 구현
- **문제**: 두 개의 오디오 플레이어를 사용해 2개의 음원이 겹쳐서 재생되는 매시업 기능 구현해야 합니다.
- **해결**:
  1. 첫 번째 플레이어에서 새로운 트랙이 재생되면 타이머를 시작합니다.
  2. 타이머가 끝나거나 트랙이 종료되면 두 번째 플레이어에서 무작위 위치에서 트랙을 재생합니다. 두 번째 플레이어의 초기 볼륨은 0입니다.
  3. 첫 번째 플레이어의 볼륨을 서서히 줄이고, 두 번째 플레이어의 볼륨을 서서히 올립니다.
  4. 이 과정을 반복하여 매시업 효과를 구현합니다.

### 4. 안드로이드 11 이상의 Scoped Storage로 인해 스토리지 스캔 오류 발생
- **문제**: 안드로이드 11(API 레벨 30)부터 적용된 Scoped Storage로 인해 기존 파일 접근 방식이 차단됩니다.
- **해결**:
  1. `AndroidManifest.xml`에 `android.permission.MANAGE_EXTERNAL_STORAGE` 권한을 추가합니다.
  2. `permission_handler` 패키지를 사용해 모든 파일 접근 권한을 요청합니다.
  3. 이후, `dart:io`를 사용해 파일에 접근 가능하며 외부 저장소 경로는 `external_path` 패키지를 사용해 찾을 수 있습니다.

### 5. 백그라운드 튕김 현상
- **문제**: 앱이 백그라운드에서 실행될 때 12-15분 후에 강제로 종료되는 현상이 발생합니다.
- **해결**:
  1. 백그라운드에서 실행될 수 있도록 `audio_service` 패키지를 사용합니다.
  2. `components/audio_handler` 파일을 추가하고 `AudioPlayer.playbackEventStream.listen`에 `playbackState.add`를 실행하여 백그라운드에서도 동작하도록 설정합니다.

### 6. database is locked 오류 발생
- **문제**: `sqflite` 데이터베이스 초기화 시 "database is locked (code 5 sqlite_busy)" 오류가 발생합니다.
- **해결**:
  1. `sqflite`는 동시 읽기/쓰기 작업을 지원하지 않으므로 첫 파일 생성 및 초기화 시에는 다른 작업을 제한해야 합니다.
  2. 데이터베이스 상태를 체크하는 프로퍼티를 추가하여 초기화 중에는 CRUD 연산을 제한합니다.

### 7. 플레이리스트 로컬 저장
- **문제**: 음악 플레이리스트를 로컬에 저장해야 합니다.
- **해결**: `sqflite`를 사용해 로컬 데이터베이스에 저장하고 관리합니다.

### 8. 비주얼라이저 추가
- **문제**: 현재 재생 중인 음원에 반응하는 비주얼라이저 효과를 구현해야 합니다.
- **해결**:
  1. 음원 로드 시, 해당 파일의 바이트 리스트를 추출합니다.
  2. 추출한 샘플 데이터를 바탕으로 RMS 값을 계산하여, 이를 비주얼라이저 애니메이션에 반영합니다.

### 9. 통합 오디오 플레이어 인터페이스
- **문제**: `just_audio`와 `audioplayers` 패키지를 동시에 사용할 때 API의 일관성을 유지하기 어렵습니다.
- **해결**: `AudioPlayer` 인터페이스 클래스를 통해 두 API를 통합하여 추상화된 플레이어 API를 제공하고, 오디오 파일 이외의 코드에서 오디오 패키지를 임포트하지 않도록 합니다.

### 10. 윈도우 버전 출시
- **문제**: 기존 Flutter 앱을 윈도우에서 실행할 수 없었습니다.
- **해결**: 윈도우용 버전을 새롭게 출시하며, 윈도우에서도 `audioplayers` 패키지를 활용해 오디오 재생을 지원하고 `sqlite` 데이터베이스는 `sqflite_common_ffi` 패키지를 통해 사용할 수 있습니다.

### 11. mp4 백그라운드 재생 기능 추가
- **문제**: 일반적으로 flutter에서는 mp4 파일의 재생을 지원하지 않습니다.
- **해결**: `video_player`와 `media_kit` 패키지를 사용하면 mp4 파일을 재생할 수 있습니다.
